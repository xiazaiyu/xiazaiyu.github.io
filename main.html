<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>摆的快慢｜可调长度与质量的钟摆实验（五年级上）</title>
  <style>
    :root{
      --bg:#0f172a;          /* 深蓝背景 */
      --card:#111827;        /* 面板 */
      --text:#e5e7eb;        /* 文字 */
      --muted:#94a3b8;       /* 次级文字 */
      --accent:#22c55e;      /* 绿色强调 */
      --accent2:#60a5fa;     /* 蓝色强调 */
      --danger:#ef4444;
      --shadow:0 10px 25px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Noto Sans CJK SC", Helvetica, Arial;
      color:var(--text);
      background:radial-gradient(1200px 800px at 70% -10%, #1f2937 0%, var(--bg) 40%, #0b1224 100%);
    }
    .wrap{max-width:1100px;margin:24px auto;padding:12px}
    .grid{
      display:grid;gap:16px;grid-template-columns:1.2fr 1fr;align-items:stretch
    }
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,#0b1224 0%, #0a101e 100%);border:1px solid #1f2937;border-radius:var(--radius);box-shadow:var(--shadow)}
    .panel{padding:20px}
    h1{font-size:22px;margin:8px 0 14px;letter-spacing:.5px}
    h2{font-size:16px;margin:0 0 12px;color:var(--muted);font-weight:600}

    /* 画布区域 */
    .stage{position:relative;min-height:520px}
    canvas{width:100%;height:520px;display:block;border-bottom-left-radius:var(--radius);border-bottom-right-radius:var(--radius)}
    .stage-header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid #1f2937}
    .badge{font-size:12px;color:#cbd5e1;border:1px solid #334155;border-radius:999px;padding:4px 10px;background:#0b1326}

    /* 控制区 */
    .controls{display:grid;gap:14px}
    .row{display:grid;grid-template-columns:110px 1fr 80px;gap:10px;align-items:center}
    .row input[type="range"]{width:100%}
    .row input[type="number"]{width:100%;background:#0b1224;border:1px solid #1f2937;border-radius:10px;color:var(--text);padding:8px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    button{cursor:pointer;border:none;border-radius:12px;padding:10px 14px;font-weight:600;box-shadow:var(--shadow);transition:transform .05s ease}
    button:active{transform:scale(.98)}
    .start{background:linear-gradient(180deg,#16a34a,#15803d);color:white}
    .pause{background:linear-gradient(180deg,#60a5fa,#3b82f6);color:#06223a}
    .reset{background:linear-gradient(180deg,#f87171,#ef4444);color:#2b0b0b}
    .note{color:var(--muted);font-size:13px;line-height:1.5;margin-top:8px}

    /* 数字显示 */
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .stat{background:#0b1224;border:1px solid #1f2937;border-radius:12px;padding:12px}
    .stat .k{font-size:12px;color:#93c5fd}
    .stat .v{font-size:22px;font-weight:700;margin-top:4px}
    .hl{color:var(--accent)}
    .tip{font-size:12px;color:#9ca3af;margin-top:6px}
    .footer{margin-top:14px;border-top:1px dashed #1f2937;padding-top:10px;color:#9aa4b2;font-size:13px;line-height:1.6}
    a{color:#86efac}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>摆的快慢（可调长度与质量）</h1>
    <div class="grid">
      <!-- 左侧：画布 -->
      <div class="card stage">
        <div class="stage-header">
          <span class="badge">小提示：开始后，数一数它每次经过中间的次数。</span>
          <span class="badge" id="modeInfo">小角度近似</span>
        </div>
        <canvas id="sim" width="700" height="520" aria-label="钟摆画布"></canvas>
      </div>

      <!-- 右侧：控制与数据显示 -->
      <div class="card panel">
        <h2>参数</h2>
        <div class="controls">
          <div class="row">
            <label for="len">摆绳长度 L（米）</label>
            <input id="len" type="range" min="0.20" max="2.00" step="0.01" value="1.00">
            <input id="lenNum" type="number" min="0.20" max="2.00" step="0.01" value="1.00">
          </div>
          <div class="row">
            <label for="mass">摆锤质量 m（千克）</label>
            <input id="mass" type="range" min="0.05" max="1.50" step="0.01" value="0.20">
            <input id="massNum" type="number" min="0.05" max="1.50" step="0.01" value="0.20">
          </div>
          <div class="row">
            <label for="ang">起始角度 θ₀（度）</label>
            <input id="ang" type="range" min="5" max="30" step="1" value="15">
            <input id="angNum" type="number" min="5" max="30" step="1" value="15">
          </div>

          <div class="btns">
            <button class="start" id="startBtn">开始</button>
            <button class="pause" id="pauseBtn" disabled>暂停</button>
            <button class="reset" id="resetBtn">复位</button>
          </div>

          <div class="stats">
            <div class="stat">
              <div class="k">计时（秒）</div>
              <div class="v" id="time">0.00</div>
              <div class="tip">运行时自动累加</div>
            </div>
            <div class="stat">
              <div class="k">经过中线次数</div>
              <div class="v hl" id="passes">0</div>
              <div class="tip">每次从一侧到另一侧经过中间加 1</div>
            </div>
            <div class="stat">
              <div class="k">完整摆动（来回）</div>
              <div class="v" id="fullSwings">0</div>
              <div class="tip">≈ 经过中线次数 ÷ 2</div>
            </div>
          </div>

          <div class="stats" style="margin-top:6px">
            <div class="stat">
              <div class="k">理论周期 T（秒）</div>
              <div class="v" id="Ttheory">—</div>
              <div class="tip">T ≈ 2π√(L/g)，与质量无关</div>
            </div>
            <div class="stat">
              <div class="k">重力加速度 g（m/s²）</div>
              <div class="v" id="gview">9.81</div>
              <div class="tip">地球表面取 9.81</div>
            </div>
            <div class="stat">
              <div class="k">当前角度 θ（度）</div>
              <div class="v" id="angleNow">0.0</div>
              <div class="tip">实时显示</div>
            </div>
          </div>

          <p class="note">
            观察：改变<strong>长度 L</strong>会改变快慢；改变<strong>质量 m</strong>几乎不会改变快慢（在小角度时）。
          </p>
          <div class="footer">
            说明：本页面使用简化物理模型（单摆，小角度）。可用于五年级上册“摆的快慢”的探究活动。
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== 常量与状态 ======
    const g = 9.81;                  // 重力加速度（m/s^2）
    const canvas = document.getElementById('sim');
    const ctx = canvas.getContext('2d');

    // UI 元素
    const lenRange = document.getElementById('len');
    const lenNum   = document.getElementById('lenNum');
    const massRange= document.getElementById('mass');
    const massNum  = document.getElementById('massNum');
    const angRange = document.getElementById('ang');
    const angNum   = document.getElementById('angNum');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');

    const timeView = document.getElementById('time');
    const passesView = document.getElementById('passes');
    const fullView   = document.getElementById('fullSwings');
    const Tview      = document.getElementById('Ttheory');
    const gview      = document.getElementById('gview');
    const angleNow   = document.getElementById('angleNow');

    const modeInfo   = document.getElementById('modeInfo');

    // 模型状态（角度单位用弧度）
    let L = parseFloat(lenRange.value);     // 摆长（m）
    let m = parseFloat(massRange.value);    // 质量（kg）-- 在理想单摆周期中不起作用
    let theta0deg = parseFloat(angRange.value);
    let theta = theta0deg * Math.PI/180;    // 当前角度（rad）
    let omega = 0;                          // 角速度（rad/s）

    // 计时与计数
    let running = false;
    let lastTS = 0;           // 上一帧时间戳（ms）
    let elapsed = 0;          // 运行总时间（s）
    let passCount = 0;        // 经过中线次数
    let prevTheta = theta;    // 用于检测过中线

    // 绘图基准
    const cx = canvas.width/2;       // 悬点 x
    const cy = 70;                   // 悬点 y
    const pxPerMeter = 220;          // 将米换算为像素（比例）

    // ====== 工具函数 ======
    function clamp(v, min, max){return Math.max(min, Math.min(max, v));}
    function fmt(n, d=2){return Number(n).toFixed(d)}

    function updateTheory(){
      const T = 2*Math.PI*Math.sqrt(L/g);
      Tview.textContent = fmt(T, 2);
    }

    // 同步滑块与数字框
    function linkRangeAndNumber(range, num, onChange){
      const sync = (src, dst)=>{dst.value = src.value; onChange && onChange(parseFloat(src.value));};
      range.addEventListener('input', ()=> sync(range, num));
      num.addEventListener('input', ()=> {num.value = clamp(num.value, num.min, num.max); sync(num, range)});
      range.addEventListener('change', ()=> onChange && onChange(parseFloat(range.value)));
      num.addEventListener('change', ()=> onChange && onChange(parseFloat(num.value)));
    }

    linkRangeAndNumber(lenRange, lenNum, v=>{L = v; updateTheory();});
    linkRangeAndNumber(massRange, massNum, v=>{m = v; /* 质量不影响周期（理想模型） */});
    linkRangeAndNumber(angRange, angNum, v=>{theta0deg = v; if(!running){theta = theta0deg*Math.PI/180; omega = 0;}});

    updateTheory();

    // ====== 动力学（无阻尼小角近似/精确正弦，二阶欧拉积分） ======
    const useSmallAngle = true;  // 保持为 true：便于五年级课程目标。

    function step(dt){ // dt: 秒
      // 角加速度（rad/s^2）
      const alpha = useSmallAngle
        ? -(g/L) * theta           // 小角近似：sinθ ≈ θ
        : -(g/L) * Math.sin(theta);
      // 简单积分（半隐式欧拉，能量更稳）
      omega += alpha * dt;
      theta += omega * dt;

      // 经过中线检测：从负 -> 正，或从正 -> 负，都算 1 次
      if ((prevTheta <= 0 && theta > 0) || (prevTheta >= 0 && theta < 0)) {
        passCount += 1;
        passesView.textContent = passCount;
        fullView.textContent = Math.floor(passCount/2);
      }
      prevTheta = theta;

      // 更新读数
      angleNow.textContent = fmt(theta * 180/Math.PI, 1);
    }

    // ====== 动画循环 ======
    function loop(ts){
      if(!running){return}
      if(!lastTS) lastTS = ts;
      const dt = Math.min(0.05, (ts - lastTS)/1000); // 上限 50ms，防跳帧
      lastTS = ts;

      step(dt);
      elapsed += dt;
      timeView.textContent = fmt(elapsed, 2);

      draw();
      requestAnimationFrame(loop);
    }

    // ====== 绘制 ======
    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // 背景网格（柔和）
      ctx.save();
      const grid = 40; ctx.globalAlpha = 0.12; ctx.strokeStyle = '#9ca3af';
      for(let x=0; x<canvas.width; x+=grid){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke();}
      for(let y=0; y<canvas.height; y+=grid){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke();}
      ctx.restore();

      // 悬点
      ctx.fillStyle = '#60a5fa';
      ctx.beginPath(); ctx.arc(cx, cy, 5, 0, Math.PI*2); ctx.fill();

      // 绳与摆锤位置
      const lenPx = L * pxPerMeter;
      const x = cx + lenPx * Math.sin(theta);
      const y = cy + lenPx * Math.cos(theta);

      // 绳
      ctx.strokeStyle = '#86efac';
      ctx.lineWidth = 3;
      ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(x, y); ctx.stroke();

      // 中线（虚线）
      ctx.setLineDash([6,6]);
      ctx.strokeStyle = '#94a3b8';
      ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(cx, cy + lenPx + 40); ctx.stroke();
      ctx.setLineDash([]);

      // 摆锤（质量仅用于显示大小变化，便于直观比较，但不影响周期）
      const r = 14 + 10 * (m - 0.05) / (1.50 - 0.05); // 视觉半径
      const grad = ctx.createRadialGradient(x-4,y-4,2, x,y, r+6);
      grad.addColorStop(0,'#93c5fd');
      grad.addColorStop(1,'#1e293b');
      ctx.fillStyle = grad;
      ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();

      // 地面阴影
      ctx.globalAlpha = 0.18; ctx.fillStyle = '#000';
      ctx.beginPath(); ctx.ellipse(x, y+r+10, r*1.2, r*0.5, 0, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;

      // 文字标注
      ctx.fillStyle = '#cbd5e1';
      ctx.font = '12px ui-sans-serif, system-ui';
      ctx.fillText(`L = ${fmt(L,2)} m`, 14, 22);
      ctx.fillText(`m = ${fmt(m,2)} kg`, 14, 40);
      ctx.fillText(`θ = ${fmt(theta*180/Math.PI,1)}°`, 14, 58);
    }

    // ====== 控件事件 ======
    function setRunning(v){
      running = v;
      startBtn.disabled = v;
      pauseBtn.disabled = !v;
      // 长度和参数在运行中仍可改，但建议课堂中先暂停再改
    }

    startBtn.addEventListener('click', ()=>{
      if(!running){
        setRunning(true);
        lastTS = 0;
        requestAnimationFrame(loop);
      }
    });

    pauseBtn.addEventListener('click', ()=>{
      setRunning(false);
    });

    resetBtn.addEventListener('click', ()=>{
      setRunning(false);
      elapsed = 0; timeView.textContent = '0.00';
      passCount = 0; passesView.textContent = '0'; fullView.textContent = '0';
      theta = theta0deg * Math.PI/180; omega = 0; prevTheta = theta;
      draw();
    });

    // 初始绘制
    draw();
  </script>
</body>
</html>
